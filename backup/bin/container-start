#!/bin/bash

# script to run rolling-backup in a cronjob inside a container
# it uses environment variables to set the cron schedule and options for rolling-backup
# it also creates the logfile if it does not exist yet

# translate boolean env variables to command line options
CHECKSUM_OPTION=""
if [[ "${CREATE_CHECKSUMS}" == "true" ]]; then
    CHECKSUM_OPTION="--checksum"
fi
PREV_RM_OPTION=""
if [[ "${REMOVE_CHECKSUM_EQUIV_PREVIOUS_BACKUP}" == "true" ]]; then
    PREV_RM_OPTION="--remove-eq-prev"
fi

echo "[..] Setting timezone"
ln -snf "/usr/share/zoneinfo/${CONTAINER_TIMEZONE}" /etc/localtime
echo "${CONTAINER_TIMEZONE}" >/etc/timezone
dpkg-reconfigure -f noninteractive tzdata
echo "[ok] Container timezone set to: ${CONTAINER_TIMEZONE}"
echo

# create logfile if it does not exist yet
echo "[..] Create logfile "
mkdir -p "$(dirname ${LOGFILE})" && touch "${LOGFILE}"
echo "[ok] logfile created at: ${LOGFILE}"
echo

# add cronjob to crontab and start cron in background and tail logfile
printf "$CRON_SCHEDULE /app/mariadb-rolling-backup $CHECKSUM_OPTION $PREV_RM_OPTION --user root --password ${MYSQL_ROOT_PASSWORD} --host ${MYSQL_HOST} --dir /backups  --keep ${MAX_NUM_BACKUPS_TO_KEEP} --exclude-tables-in-checksum ${TABLES_TO_EXCLUDE_IN_CHECKSUM} ${MYSQL_DATABASE}  >> $LOGFILE 2>&1\n" | crontab -
cron
tail -f "$LOGFILE"
