#!/bin/bash

# Default configuration
scriptdir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
BACKUP_DIR="$scriptdir/../data/backups/"
NAME="mariadb"
DAYS_TO_KEEP=20

# Usage/help function
usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Options:
  -d, --dir DIR       Set backup directory (default: $scriptdir/../data/backups/)
  -k, --keep DAYS     Number of days to keep backups (default: 20)
  -h, --help          Show this help message and exit

Example:
  $(basename "$0") -d /tmp/backups -k 10
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -d|--dir)
            BACKUP_DIR="$2"
            shift 2
            ;;
        -k|--keep)
            DAYS_TO_KEEP="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Ensure backup dir exists
mkdir -p "$BACKUP_DIR"

# Filename with date
DATE=$(date +%Y-%m-%d)
# test # DATE=$(date +%Y%m%d_%H%M%S)
DUMPFILE="$BACKUP_DIR/${NAME}-$DATE.sql.gz"

# Dump database safely with recommended flags
"$scriptdir"/backup "$DUMPFILE"
# test # echo "test" > "$DUMPFILE"

# Cleanup old backups
find "$BACKUP_DIR" -name "${NAME}-*.sql.gz" -mtime +"$DAYS_TO_KEEP" -delete
# test # find "$BACKUP_DIR" -name "${NAME}-*.sql.gz" ! -newermt '-20 seconds' -delete
