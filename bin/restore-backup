#!/bin/bash

# Config
MAX_PACKET_SIZE="1G"
CONTAINER="mariadb"

# Define usage information
USAGE="Usage: $(basename "$0") [-h|--help] FILEPATH

DESCRIPTION
   Restore the domjudge MariaDB database from a dumpfile 

OPTIONS
  -h, --help    Display this help message and exit.

ARGUMENTS
  FILEPATH      The path where the database dump file will is located.

EXAMPLE
  First bring your containers down. 
     
     $ docker compose down

  Then start only the mariadb database container

     $ docker compose up -d mariadb

  Restore the database from a dumpfile     
  
     $ bin/restore-backup data/backups/mariadb.sql.gz
     INFO: Restoring from the dumpfile 'data/backups/mariadb.sql.gz'
     INFO: dumping mariadb database succesful

  Delete the old passwords files, 
  and let new ones generated on start of the domserver container 

     $ sudo rm  data/passwords/*   

  Start all containers 

     $ docker compose up -d
      ✔ Network caddy_reverseproxy  Created
      ✔ Container mariadb           Running
      ✔ Container domserver         Started
      ✔ Container judgehost-1       Started
      ✔ Container judgehost-0       Started

   Now you should be able to login as 'admin' user using the password
   in data/passwords/admin.pw 

   Note that if you remembered the admin password of the backup, 
   then you could skip resetting the admin password. 

"

info() {
   echo "INFO: $@" 1>&2
}
error() {
   echo "ERROR: $@" 1>&2
}

# Parse command line options
while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do
   case $1 in
   -h | --help)
      echo "$USAGE"
      exit
      ;;
   *)
      error "Unknown option: $1"
      error "$USAGE"
      exit 1
      ;;
   esac
done

dumpfile="$1"

if [[ -z "$dumpfile" ]]; then
   error "Missing the dumpfile argument."
   error "$USAGE"
   exit 1
fi

if [[ -f "$dumpfile" ]]; then
   info "Restoring from the dumpfile '$dumpfile'"
else
   error "The dumpfile '$dumpfile' does not exist."
   exit 1
fi

# Check if the mariadb container is running
if ! docker ps | grep -q "$CONTAINER"; then
   error "The 'mariadb' docker container is not running."
   exit 1
fi

# restore database from dumpfile using mariadb command within the docker container
# environment variables MYSQL_ROOT_PASSWORD and MYSQL_DATABASE set in docker-compose.yml
set -o pipefail
gunzip -c "$dumpfile" |
   docker exec -i "$CONTAINER" /bin/bash -c \
      '/usr/bin/mariadb --max-allowed-packet='"$MAX_PACKET_SIZE"'  --user root  -p$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE'

# gunzip -c "$dumpfile" | \
# docker exec -i "$CONTAINER" /bin/bash -c \
# "/usr/bin/mariadb --max-allowed-packet=$MAX_PACKET_SIZE --user root -p\$MYSQL_ROOT_PASSWORD \$MYSQL_DATABASE"

exit_status=$?
if [[ $exit_status -ne 0 ]]; then
   error "restoring mariadb database failed"
   exit $exit_status
else
   info "dumping mariadb database succesful"
fi
